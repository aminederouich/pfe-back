name: ğŸš€ Auto Version After Merge PR (API Version)

on:
  push:
    branches: [ main ]

permissions:
  contents: write
  pull-requests: read

jobs:
  auto-version:
    if: github.ref == 'refs/heads/main' && contains(github.event.head_commit.message, 'Merge pull request') && !contains(github.event.head_commit.message, '[skip version]') && !contains(github.event.head_commit.message, 'chore(release)')
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.AUTO_VERSION_TOKEN || secrets.GITHUB_TOKEN }}

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.11.0'
        registry-url: 'https://registry.npmjs.org'

    - name: ğŸ“¦ Install dependencies
      run: npm ci

    - name: ğŸ§ª Run tests
      run: npm test

    - name: ğŸ” Run linting
      run: npm run lint

    - name: ğŸ” Analyze merged PR commits
      id: analyze-commits
      run: |
        echo "ğŸ”„ Analyzing merged PR commits..."
        
        # RÃ©cupÃ©rer le numÃ©ro de la PR depuis le message de merge
        PR_NUMBER=$(echo "${{ github.event.head_commit.message }}" | grep -oP 'Merge pull request #\K\d+')
        echo "PR Number: $PR_NUMBER"
        
        if [ -z "$PR_NUMBER" ]; then
          echo "âŒ Could not extract PR number from merge commit"
          echo "bump_type=patch" >> $GITHUB_OUTPUT
          echo "emoji=ğŸŸ¢" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # RÃ©cupÃ©rer les commits de la PR
        echo "ğŸ“ Fetching commits from PR #$PR_NUMBER..."
        
        # Utiliser l'API GitHub pour rÃ©cupÃ©rer les commits de la PR
        PR_COMMITS=$(curl -s -H "Authorization: token ${{ secrets.AUTO_VERSION_TOKEN || secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER/commits" | \
          jq -r '.[].commit.message')
        
        echo "Commits from PR:"
        echo "$PR_COMMITS"
        
        # Analyser les commits pour dÃ©terminer le type de bump
        if echo "$PR_COMMITS" | grep -qE "(^feat(\(.+\))?!:|^fix(\(.+\))?!:|^refactor(\(.+\))?!:|BREAKING CHANGE)"; then
          echo "ğŸ”´ MAJOR version bump detected (breaking changes)"
          echo "bump_type=major" >> $GITHUB_OUTPUT
          echo "emoji=ğŸ”´" >> $GITHUB_OUTPUT
        elif echo "$PR_COMMITS" | grep -qE "(^feat(\(.+\))?:|feat:)"; then
          echo "ğŸŸ¡ MINOR version bump detected (new features)"
          echo "bump_type=minor" >> $GITHUB_OUTPUT
          echo "emoji=ğŸŸ¡" >> $GITHUB_OUTPUT
        elif echo "$PR_COMMITS" | grep -qE "(^fix(\(.+\))?:|^perf(\(.+\))?:|^revert(\(.+\))?:|fix:|perf:)"; then
          echo "ğŸŸ¢ PATCH version bump detected (bug fixes)"
          echo "bump_type=patch" >> $GITHUB_OUTPUT
          echo "emoji=ğŸŸ¢" >> $GITHUB_OUTPUT
        else
          echo "ğŸŸ¢ Default PATCH version bump (no conventional commits found)"
          echo "bump_type=patch" >> $GITHUB_OUTPUT
          echo "emoji=ğŸŸ¢" >> $GITHUB_OUTPUT
        fi

    - name: ğŸ“ˆ Update package version locally
      id: update-version
      run: |
        CURRENT_VERSION=$(node -p "require('./package.json').version")
        BUMP_TYPE="${{ steps.analyze-commits.outputs.bump_type }}"
        
        echo "Current version: $CURRENT_VERSION"
        echo "Bump type: $BUMP_TYPE"
        
        # Mettre Ã  jour la version dans package.json et package-lock.json
        npm version $BUMP_TYPE --no-git-tag-version
        
        NEW_VERSION=$(node -p "require('./package.json').version")
        echo "New version: $NEW_VERSION"
        echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
        
        # VÃ©rifier que package-lock.json a aussi Ã©tÃ© mis Ã  jour
        LOCK_VERSION=$(node -p "require('./package-lock.json').version")
        echo "Package-lock version: $LOCK_VERSION"
        
        if [ "$NEW_VERSION" != "$LOCK_VERSION" ]; then
          echo "âš ï¸ Package-lock.json version mismatch, fixing..."
          npm install --package-lock-only
        fi

    - name: ğŸš€ Commit and push via API (bypass branch protection)
      run: |
        NEW_VERSION="${{ steps.update-version.outputs.version }}"
        BUMP_TYPE="${{ steps.analyze-commits.outputs.bump_type }}"
        EMOJI="${{ steps.analyze-commits.outputs.emoji }}"
        
        # Configurer Git pour l'API
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # Message de commit (Ã©chapper les caractÃ¨res spÃ©ciaux)
        COMMIT_MESSAGE="chore(release): bump version to $NEW_VERSION [skip version]

        Auto-generated version bump
        Type: $BUMP_TYPE
        Version: $NEW_VERSION
        Generated by GitHub Actions"
        
        # Encoder les fichiers en base64 (mÃ©thode plus sÃ»re)
        echo "ğŸ“ Encoding files..."
        PACKAGE_JSON_CONTENT=$(cat package.json | base64 -w 0)
        PACKAGE_LOCK_CONTENT=$(cat package-lock.json | base64 -w 0)
        
        # RÃ©cupÃ©rer les SHA des fichiers actuels
        echo "ğŸ“‹ Getting current file SHAs..."
        PACKAGE_JSON_SHA=$(curl -s -H "Authorization: token ${{ secrets.AUTO_VERSION_TOKEN || secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}/contents/package.json" | jq -r '.sha')
        
        PACKAGE_LOCK_SHA=$(curl -s -H "Authorization: token ${{ secrets.AUTO_VERSION_TOKEN || secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}/contents/package-lock.json" | jq -r '.sha')
        
        echo "package.json SHA: $PACKAGE_JSON_SHA"
        echo "package-lock.json SHA: $PACKAGE_LOCK_SHA"
        
        # CrÃ©er fichiers temporaires pour Ã©viter les problÃ¨mes d'arguments trop longs
        echo "ğŸ“ Creating temporary JSON files..."
        
        # JSON pour package.json
        cat > /tmp/package_json_update.json << EOF
{
  "message": "chore(release): bump version to $NEW_VERSION [skip version]",
  "content": "$PACKAGE_JSON_CONTENT",
  "sha": "$PACKAGE_JSON_SHA",
  "branch": "main"
}
EOF
        
        # Mettre Ã  jour package.json via API
        echo "ğŸ“ Updating package.json via API..."
        PACKAGE_JSON_RESPONSE=$(curl -s -X PUT \
          -H "Authorization: token ${{ secrets.AUTO_VERSION_TOKEN || secrets.GITHUB_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d @/tmp/package_json_update.json \
          "https://api.github.com/repos/${{ github.repository }}/contents/package.json")
        
        echo "Package.json response: $PACKAGE_JSON_RESPONSE"
        
        # VÃ©rifier si la mise Ã  jour a rÃ©ussi
        if echo "$PACKAGE_JSON_RESPONSE" | jq -e '.commit' > /dev/null; then
          echo "âœ… package.json updated successfully"
        else
          echo "âŒ Failed to update package.json"
          echo "$PACKAGE_JSON_RESPONSE"
          exit 1
        fi
        
        # Attendre un peu pour Ã©viter les conflits
        sleep 3
        
        # Pour package-lock.json, utilisons une approche diffÃ©rente si le fichier est trop gros
        LOCK_FILE_SIZE=$(wc -c < package-lock.json)
        echo "package-lock.json size: $LOCK_FILE_SIZE bytes"
        
        if [ "$LOCK_FILE_SIZE" -gt 1000000 ]; then
          echo "âš ï¸ package-lock.json is too large for API, using git push method..."
          
          # RÃ©cupÃ©rer les derniers changements
          git fetch origin main
          git checkout main
          git pull origin main
          
          # RÃ©gÃ©nÃ©rer package-lock.json
          npm install --package-lock-only
          
          # VÃ©rifier que la version correspond
          LOCK_VERSION=$(node -p "require('./package-lock.json').version")
          if [ "$LOCK_VERSION" != "$NEW_VERSION" ]; then
            echo "ï¿½ Fixing package-lock.json version..."
            npm version $NEW_VERSION --no-git-tag-version
          fi
          
          # Commiter et pousser avec le token spÃ©cial
          git add package-lock.json
          git commit -m "chore(release): update package-lock.json to $NEW_VERSION [skip version]"
          git push https://x-access-token:${{ secrets.AUTO_VERSION_TOKEN || secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git main
          
        else
          echo "ğŸ“ Updating package-lock.json via API..."
          
          # JSON pour package-lock.json
          cat > /tmp/package_lock_update.json << EOF
{
  "message": "chore(release): update package-lock.json to $NEW_VERSION [skip version]",
  "content": "$PACKAGE_LOCK_CONTENT",
  "sha": "$PACKAGE_LOCK_SHA",
  "branch": "main"
}
EOF
          
          PACKAGE_LOCK_RESPONSE=$(curl -s -X PUT \
            -H "Authorization: token ${{ secrets.AUTO_VERSION_TOKEN || secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d @/tmp/package_lock_update.json \
            "https://api.github.com/repos/${{ github.repository }}/contents/package-lock.json")
          
          echo "Package-lock.json response: $PACKAGE_LOCK_RESPONSE"
          
          if echo "$PACKAGE_LOCK_RESPONSE" | jq -e '.commit' > /dev/null; then
            echo "âœ… package-lock.json updated successfully"
          else
            echo "âŒ Failed to update package-lock.json"
            echo "$PACKAGE_LOCK_RESPONSE"
          fi
        fi

    - name: ğŸ·ï¸ Create Git tag via API
      run: |
        NEW_VERSION="${{ steps.update-version.outputs.version }}"
        BUMP_TYPE="${{ steps.analyze-commits.outputs.bump_type }}"
        EMOJI="${{ steps.analyze-commits.outputs.emoji }}"
        
        # RÃ©cupÃ©rer le SHA du dernier commit sur main
        LATEST_COMMIT_SHA=$(curl -s -H "Authorization: token ${{ secrets.AUTO_VERSION_TOKEN || secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}/git/refs/heads/main" | jq -r '.object.sha')
        
        echo "Creating tag v$NEW_VERSION for commit $LATEST_COMMIT_SHA"
        
        # CrÃ©er l'objet tag
        curl -X POST \
          -H "Authorization: token ${{ secrets.AUTO_VERSION_TOKEN || secrets.GITHUB_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d "{
            \"tag\": \"v$NEW_VERSION\",
            \"message\": \"Release version $NEW_VERSION\n\n$EMOJI $BUMP_TYPE release\nğŸ·ï¸ Version: $NEW_VERSION\nğŸ—“ï¸ Date: $(date -u +\"%Y-%m-%d %H:%M:%S UTC\")\nğŸ¤– Auto-generated by GitHub Actions\",
            \"object\": \"$LATEST_COMMIT_SHA\",
            \"type\": \"commit\"
          }" \
          "https://api.github.com/repos/${{ github.repository }}/git/tags"
        
        # CrÃ©er la rÃ©fÃ©rence
        curl -X POST \
          -H "Authorization: token ${{ secrets.AUTO_VERSION_TOKEN || secrets.GITHUB_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d "{
            \"ref\": \"refs/tags/v$NEW_VERSION\",
            \"sha\": \"$LATEST_COMMIT_SHA\"
          }" \
          "https://api.github.com/repos/${{ github.repository }}/git/refs"

    - name: ğŸ“‹ Create GitHub Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.AUTO_VERSION_TOKEN || secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ steps.update-version.outputs.version }}
        release_name: ${{ steps.analyze-commits.outputs.emoji }} Release v${{ steps.update-version.outputs.version }}
        body: |
          ## ğŸš€ Release v${{ steps.update-version.outputs.version }}
          
          ### ğŸ“Š Version Information
          - **Version**: `${{ steps.update-version.outputs.version }}`
          - **Type**: `${{ steps.analyze-commits.outputs.bump_type }}` release
          - **Generated**: ${{ github.event.head_commit.timestamp }}
          
          ### ğŸ”„ Triggered by
          Merge commit: `${{ github.event.head_commit.message }}`
          
          ### ğŸ“ Changes
          This release was automatically generated after merging a pull request.
          Version was updated in both `package.json` and `package-lock.json`.
          
          See the [full changelog](https://github.com/${{ github.repository }}/compare/v${{ steps.update-version.outputs.version }}...v${{ steps.update-version.outputs.version }}) for details.
          
          ---
          
          ğŸ¤– **Auto-generated by GitHub Actions via API (bypasses branch protection)**
        draft: false
        prerelease: false

    - name: ğŸŠ Success notification
      run: |
        echo "ğŸ‰ SUCCESS! Version automatically updated via API!"
        echo "ğŸ“¦ New version: ${{ steps.update-version.outputs.version }}"
        echo "ğŸ“ˆ Bump type: ${{ steps.analyze-commits.outputs.bump_type }}"
        echo "ğŸ·ï¸ Tag created: v${{ steps.update-version.outputs.version }}"
        echo "ğŸ“‹ Release created: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.update-version.outputs.version }}"
        echo ""
        echo "âœ… Files updated via GitHub API:"
        echo "  - package.json"
        echo "  - package-lock.json"
        echo ""
        echo "ğŸ”— View changes: https://github.com/${{ github.repository }}/commits/main"
