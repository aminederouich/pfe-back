name: ğŸš€ Auto Version After Merge PR (Hybrid)

on:
  push:
    branches: [ main ]

permissions:
  contents: write
  pull-requests: read

jobs:
  auto-version:
    if: github.ref == 'refs/heads/main' && contains(github.event.head_commit.message, 'Merge pull request') && !contains(github.event.head_commit.message, '[skip version]') && !contains(github.event.head_commit.message, 'chore(release)')
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.AUTO_VERSION_TOKEN || secrets.GITHUB_TOKEN }}

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.11.0'
        registry-url: 'https://registry.npmjs.org'

    - name: ğŸ“¦ Install dependencies
      run: npm ci

    - name: ğŸ§ª Run tests
      run: npm test

    - name: ğŸ” Run linting
      run: npm run lint

    - name: ğŸ” Analyze merged PR commits
      id: analyze-commits
      run: |
        echo "ğŸ”„ Analyzing merged PR commits..."
        
        # RÃ©cupÃ©rer le numÃ©ro de la PR depuis le message de merge
        PR_NUMBER=$(echo "${{ github.event.head_commit.message }}" | grep -oP 'Merge pull request #\K\d+')
        echo "PR Number: $PR_NUMBER"
        
        if [ -z "$PR_NUMBER" ]; then
          echo "âŒ Could not extract PR number from merge commit"
          echo "bump_type=patch" >> $GITHUB_OUTPUT
          echo "emoji=ğŸŸ¢" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # RÃ©cupÃ©rer les commits de la PR
        echo "ğŸ“ Fetching commits from PR #$PR_NUMBER..."
        
        # Utiliser l'API GitHub pour rÃ©cupÃ©rer les commits de la PR
        PR_COMMITS=$(curl -s -H "Authorization: token ${{ secrets.AUTO_VERSION_TOKEN || secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER/commits" | \
          jq -r '.[].commit.message')
        
        echo "Commits from PR:"
        echo "$PR_COMMITS"
        
        # Analyser les commits pour dÃ©terminer le type de bump
        if echo "$PR_COMMITS" | grep -qE "(^feat(\(.+\))?!:|^fix(\(.+\))?!:|^refactor(\(.+\))?!:|BREAKING CHANGE)"; then
          echo "ğŸ”´ MAJOR version bump detected (breaking changes)"
          echo "bump_type=major" >> $GITHUB_OUTPUT
          echo "emoji=ğŸ”´" >> $GITHUB_OUTPUT
        elif echo "$PR_COMMITS" | grep -qE "(^feat(\(.+\))?:|feat:)"; then
          echo "ğŸŸ¡ MINOR version bump detected (new features)"
          echo "bump_type=minor" >> $GITHUB_OUTPUT
          echo "emoji=ğŸŸ¡" >> $GITHUB_OUTPUT
        elif echo "$PR_COMMITS" | grep -qE "(^fix(\(.+\))?:|^perf(\(.+\))?:|^revert(\(.+\))?:|fix:|perf:)"; then
          echo "ğŸŸ¢ PATCH version bump detected (bug fixes)"
          echo "bump_type=patch" >> $GITHUB_OUTPUT
          echo "emoji=ğŸŸ¢" >> $GITHUB_OUTPUT
        else
          echo "ğŸŸ¢ Default PATCH version bump (no conventional commits found)"
          echo "bump_type=patch" >> $GITHUB_OUTPUT
          echo "emoji=ğŸŸ¢" >> $GITHUB_OUTPUT
        fi

    - name: ğŸ“ˆ Update package version
      id: update-version
      run: |
        CURRENT_VERSION=$(node -p "require('./package.json').version")
        BUMP_TYPE="${{ steps.analyze-commits.outputs.bump_type }}"
        
        echo "Current version: $CURRENT_VERSION"
        echo "Bump type: $BUMP_TYPE"
        
        # Mettre Ã  jour la version dans package.json et package-lock.json
        npm version $BUMP_TYPE --no-git-tag-version
        
        NEW_VERSION=$(node -p "require('./package.json').version")
        echo "New version: $NEW_VERSION"
        echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
        
        # VÃ©rifier que package-lock.json a aussi Ã©tÃ© mis Ã  jour
        LOCK_VERSION=$(node -p "require('./package-lock.json').version")
        echo "Package-lock version: $LOCK_VERSION"
        
        if [ "$NEW_VERSION" != "$LOCK_VERSION" ]; then
          echo "âš ï¸ Package-lock.json version mismatch, fixing..."
          npm install --package-lock-only
        fi

    - name: ğŸ·ï¸ Create version commit and tag with token
      run: |
        NEW_VERSION="${{ steps.update-version.outputs.version }}"
        BUMP_TYPE="${{ steps.analyze-commits.outputs.bump_type }}"
        EMOJI="${{ steps.analyze-commits.outputs.emoji }}"
        
        # Configurer Git avec l'utilisateur actions
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # Configurer l'URL avec le token pour contourner la protection
        git remote set-url origin https://x-access-token:${{ secrets.AUTO_VERSION_TOKEN || secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
        
        # Ajouter les fichiers modifiÃ©s
        git add package.json package-lock.json
        
        # CrÃ©er le commit de version
        git commit -m "chore(release): bump version to $NEW_VERSION [skip version]

        $EMOJI Auto-generated version bump
        ğŸ“ˆ Type: $BUMP_TYPE
        ğŸ·ï¸ Version: $NEW_VERSION
        ğŸ¤– Generated by GitHub Actions
        
        Files updated:
        - package.json: $NEW_VERSION
        - package-lock.json: $NEW_VERSION"
        
        # CrÃ©er le tag
        git tag -a "v$NEW_VERSION" -m "Release version $NEW_VERSION

        $EMOJI $BUMP_TYPE release
        ğŸ·ï¸ Version: $NEW_VERSION
        ğŸ—“ï¸ Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        ğŸ¤– Auto-generated by GitHub Actions"
        
        # Pousser les changements avec force si nÃ©cessaire
        echo "ğŸš€ Pushing changes..."
        git push origin main || {
          echo "âš ï¸ Normal push failed, trying force push..."
          git push origin main --force-with-lease
        }
        
        echo "ğŸ·ï¸ Pushing tag..."
        git push origin "v$NEW_VERSION" || {
          echo "âš ï¸ Tag push failed, continuing..."
        }

    - name: ğŸ“‹ Create GitHub Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.AUTO_VERSION_TOKEN || secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ steps.update-version.outputs.version }}
        release_name: ${{ steps.analyze-commits.outputs.emoji }} Release v${{ steps.update-version.outputs.version }}
        body: |
          ## ğŸš€ Release v${{ steps.update-version.outputs.version }}
          
          ### ğŸ“Š Version Information
          - **Version**: `${{ steps.update-version.outputs.version }}`
          - **Type**: `${{ steps.analyze-commits.outputs.bump_type }}` release
          - **Generated**: ${{ github.event.head_commit.timestamp }}
          
          ### ğŸ”„ Triggered by
          Merge commit: `${{ github.event.head_commit.message }}`
          
          ### ğŸ“ Changes
          This release was automatically generated after merging a pull request.
          Both `package.json` and `package-lock.json` have been updated to version `${{ steps.update-version.outputs.version }}`.
          
          ### ğŸ› ï¸ Files Updated
          - âœ… `package.json` â†’ `${{ steps.update-version.outputs.version }}`
          - âœ… `package-lock.json` â†’ `${{ steps.update-version.outputs.version }}`
          
          See the [full changelog](https://github.com/${{ github.repository }}/compare/v${{ steps.update-version.outputs.version }}...v${{ steps.update-version.outputs.version }}) for details.
          
          ---
          
          ğŸ¤– **Auto-generated by GitHub Actions (Hybrid Method)**
        draft: false
        prerelease: false

    - name: ğŸŠ Success notification
      run: |
        echo "ğŸ‰ SUCCESS! Version automatically updated!"
        echo "ğŸ“¦ New version: ${{ steps.update-version.outputs.version }}"
        echo "ğŸ“ˆ Bump type: ${{ steps.analyze-commits.outputs.bump_type }}"
        echo "ğŸ·ï¸ Tag created: v${{ steps.update-version.outputs.version }}"
        echo "ğŸ“‹ Release created: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.update-version.outputs.version }}"
        echo ""
        echo "âœ… Files updated:"
        echo "  - package.json"
        echo "  - package-lock.json"
        echo ""
        echo "ğŸ”— View changes: https://github.com/${{ github.repository }}/commits/main"
        echo ""
        echo "ğŸ”§ Method used: Hybrid (Git with token authentication)"
